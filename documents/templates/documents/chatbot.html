{% extends 'documents/base.html' %}
{% load static %}

{% block title %}AI Chatbot - DocuVault{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .message {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
    }
    
    .message.human {
        justify-content: flex-end;
    }
    
    .message.ai {
        justify-content: flex-start;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 12px;
        word-wrap: break-word;
    }
    
    .message.human .message-bubble {
        background: #007bff;
        color: white;
    }
    
    .message.ai .message-bubble {
        background: white;
        border: 1px solid #dee2e6;
    }
    
    .message-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
    }
    
    .message.human .message-icon {
        background: #0056b3;
        color: white;
    }
    
    .message.ai .message-icon {
        background: #28a745;
        color: white;
    }
    
    .sources-list {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #dee2e6;
        font-size: 0.85rem;
    }
    
    .source-item {
        padding: 5px 0;
    }
    
    .relevance-badge {
        font-size: 0.75rem;
    }
    
    .typing-indicator {
        display: none;
        padding: 12px 16px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        width: fit-content;
    }
    
    .typing-indicator.active {
        display: block;
    }
    
    .typing-indicator span {
        height: 8px;
        width: 8px;
        background: #90949c;
        border-radius: 50%;
        display: inline-block;
        margin: 0 2px;
        animation: typing 1.4s infinite;
    }
    
    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
    }
    
    .chat-input-area {
        display: flex;
        gap: 10px;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-robot"></i> AI Document Assistant
                </h2>
                <div>
                    <a href="{% url 'chat_history' %}" class="btn btn-outline-primary">
                        <i class="fas fa-history"></i> History
                    </a>
                    <a href="{% url 'rag_system_info' %}" class="btn btn-outline-info">
                        <i class="fas fa-info-circle"></i> System Info
                    </a>
                    <button id="clearChatBtn" class="btn btn-outline-danger">
                        <i class="fas fa-trash"></i> Clear Chat
                    </button>
                </div>
            </div>
            
            <!-- Stats Card -->
            <div class="stats-card">
                <div class="row text-center">
                    <div class="col-md-4">
                        <h3>{{ total_documents }}</h3>
                        <p class="mb-0">Total Documents</p>
                    </div>
                    <div class="col-md-4">
                        <h3>{{ indexed_documents }}</h3>
                        <p class="mb-0">Indexed Documents</p>
                    </div>
                    <div class="col-md-4">
                        <h3>{{ messages|length|floatformat:0 }}</h3>
                        <p class="mb-0">Messages in Session</p>
                    </div>
                </div>
            </div>
            
            <!-- Chat Container -->
            <div class="card">
                <div class="card-body">
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            {% if messages %}
                                {% for msg in messages %}
                                    <div class="message {{ msg.message_type }}">
                                        {% if msg.message_type == 'human' %}
                                            <div class="message-bubble">
                                                {{ msg.content }}
                                            </div>
                                            <div class="message-icon">
                                                <i class="fas fa-user"></i>
                                            </div>
                                        {% else %}
                                            <div class="message-icon">
                                                <i class="fas fa-robot"></i>
                                            </div>
                                            <div class="message-bubble">
                                                {{ msg.content }}
                                                {% if msg.sources %}
                                                    <div class="sources-list">
                                                        <strong><i class="fas fa-book"></i> Sources:</strong>
                                                        {% for source in msg.sources %}
                                                            <div class="source-item">
                                                                {% if source.similarity > 0.3 %}
                                                                    <span class="badge bg-success relevance-badge">游릭 High</span>
                                                                {% elif source.similarity > 0.15 %}
                                                                    <span class="badge bg-warning relevance-badge">游리 Medium</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary relevance-badge">游댮 Low</span>
                                                                {% endif %}
                                                                {{ source.source }} (Page {{ source.page }}) - {{ source.similarity|floatformat:3 }}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-comments fa-3x mb-3"></i>
                                    <p>Start a conversation by asking a question about your documents!</p>
                                </div>
                            {% endif %}
                            
                            <!-- Typing Indicator -->
                            <div class="message ai">
                                <div class="message-icon">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="typing-indicator" id="typingIndicator">
                                    <span></span><span></span><span></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chat Input -->
                        <div class="chat-input-area">
                            <textarea 
                                id="queryInput" 
                                class="form-control" 
                                placeholder="Ask a question about your documents..." 
                                rows="3"
                                style="resize: none;"></textarea>
                            <button id="sendBtn" class="btn btn-primary" style="height: fit-content;">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const chatMessages = document.getElementById('chatMessages');
    const queryInput = document.getElementById('queryInput');
    const sendBtn = document.getElementById('sendBtn');
    const clearChatBtn = document.getElementById('clearChatBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    const sessionId = {{ chat_session.id }};
    
    // Scroll to bottom
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    scrollToBottom();
    
    // Add message to chat
    function addMessage(type, content, sources = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        
        let html = '';
        if (type === 'human') {
            html = `
                <div class="message-bubble">${escapeHtml(content)}</div>
                <div class="message-icon"><i class="fas fa-user"></i></div>
            `;
        } else {
            html = `
                <div class="message-icon"><i class="fas fa-robot"></i></div>
                <div class="message-bubble">
                    ${escapeHtml(content)}
                    ${sources ? formatSources(sources) : ''}
                </div>
            `;
        }
        
        messageDiv.innerHTML = html;
        chatMessages.insertBefore(messageDiv, typingIndicator.parentElement);
        scrollToBottom();
    }
    
    // Format sources
    function formatSources(sources) {
        if (!sources || sources.length === 0) return '';
        
        let html = '<div class="sources-list"><strong><i class="fas fa-book"></i> Sources:</strong>';
        sources.forEach(source => {
            const badge = source.similarity > 0.3 ? 'success' : source.similarity > 0.15 ? 'warning' : 'secondary';
            const emoji = source.similarity > 0.3 ? '游릭' : source.similarity > 0.15 ? '游리' : '游댮';
            html += `
                <div class="source-item">
                    <span class="badge bg-${badge} relevance-badge">${emoji}</span>
                    ${escapeHtml(source.source)} (Page ${source.page}) - ${source.similarity.toFixed(3)}
                </div>
            `;
        });
        html += '</div>';
        return html;
    }
    
    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Send query
    async function sendQuery() {
        const query = queryInput.value.trim();
        if (!query) return;
        
        // Disable input
        queryInput.disabled = true;
        sendBtn.disabled = true;
        
        // Add user message
        addMessage('human', query);
        queryInput.value = '';
        
        // Show typing indicator
        typingIndicator.classList.add('active');
        scrollToBottom();
        
        try {
            const formData = new FormData();
            formData.append('query', query);
            formData.append('session_id', sessionId);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            const response = await fetch('{% url "chatbot_query" %}', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            // Hide typing indicator
            typingIndicator.classList.remove('active');
            
            if (data.success) {
                addMessage('ai', data.answer, data.sources);
            } else {
                addMessage('ai', 'Error: ' + data.error);
            }
        } catch (error) {
            typingIndicator.classList.remove('active');
            addMessage('ai', 'Error: Failed to get response. Please try again.');
            console.error(error);
        } finally {
            queryInput.disabled = false;
            sendBtn.disabled = false;
            queryInput.focus();
        }
    }
    
    // Clear chat
    async function clearChat() {
        if (!confirm('Are you sure you want to clear the chat history?')) return;
        
        try {
            const formData = new FormData();
            formData.append('session_id', sessionId);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            const response = await fetch('{% url "clear_chat" %}', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                location.reload();
            }
        } catch (error) {
            alert('Failed to clear chat');
            console.error(error);
        }
    }
    
    // Event listeners
    sendBtn.addEventListener('click', sendQuery);
    clearChatBtn.addEventListener('click', clearChat);
    
    queryInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendQuery();
        }
    });
    
    // Focus input on load
    queryInput.focus();
</script>
{% endblock %}
